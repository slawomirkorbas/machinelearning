<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <!-- Add icon library -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <title>Tic-Tac-Toe</title>
        <style type="text/css">
            div { margin: 5px;}
            table{ table-layout:fixed; }
            td.tttField {
                width:70px;
                height:70px;
                max-width:150px;
                max-height:150px;
                min-width:50px;
                min-height:50px;
                text-align: center;
                font-family: "Arial";
                font-size: 36px;
                cursor: pointer;
            }
            td.tttField:hover {
                background-color: Aquamarine;
            }
        </style>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    </head>
<body>
    <div class="container">
        <h1>Tic-Tac-Toe - machine learning test</h1>

        <div class="row">
            <div class="col-3">
                <table>
                    <tr>
                        <td class="tttField border border-0" id="0_0"></td>
                        <td class="tttField border border-top-0" id="0_1"></td>
                        <td class="tttField border border-0" id="0_2"></td>
                    </tr>
                    <tr>
                        <td class="tttField border border-left-0" id="1_0"></td>
                        <td class="tttField border" id="1_1"></td>
                        <td class="tttField border border-right-0" id="1_2"></td>
                    </tr>
                    <tr>
                        <td class="tttField border border-0" id="2_0"></td>
                        <td class="tttField border border-bottom-0" id="2_1"></td>
                        <td class="tttField border border-0" id="2_2"></td>
                    </tr>
                </table>
            </div>
            <div class="col-4">
                <div class="row">
                    <div class="col">
                        <button class="btn-sm btn-primary" type="button" onclick="resetGame()">New game</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exampleRadios" id="learnMode" value="learnMode" checked>
                            <label class="form-check-label" for="learnMode">Learning mode</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="exampleRadios" id="playMode" value="playMode" >
                            <label class="form-check-label" for="playMode">Normal play</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-5">
                <!-- downloading trained model GMF file -->
                <a download href="/tictactoe/downloadModel">
                    <button class="btn-sm btn-primary" type="submit"><i class="fa fa-download"></i>&nbsp;Download model</button>
                </a>
            </div>
        </div>
        <div class="row">
            <div class="col-5">
                <!-- uploading/downloading model file section -->
                <form id="modelUploadForm" method="POST" enctype="multipart/form-data" action="/tictactoe/loadModel">
                    <div class="row">
                        <div class="col-4"><button class="btn-sm btn-primary" type="submit">Upload model</button></div>
                        <div class="col-3"><input type="file" class="form-control-file" id="modelFile" name="modelFile"></div>
                    </div>
                </form>
            </div>
        </div>
        <!--Copyright-->
        <div class="footer-copyright py-3">
            Â© 2020 Copyright: Slawomir Korbas
        </div>
    </div>



    <script>
        var gameState = null;
        var userFigure = 'x';

        $(".tttField").click(function() {
            var cords = $(this).attr('id').split("_");
            if( gameState.matrix[parseInt(cords[0])][parseInt(cords[1])].value.trim() == "" &&
                gameState.gameResult == null)
            {
                gameState.matrix[parseInt(cords[0])][parseInt(cords[1])].value = userFigure;
                updateBoard(gameState);
                sendGameState(gameState, userFigure, cords[0], cords[1], function (newGameState) {
                    gameState = newGameState;
                    updateBoard(gameState);
                    //console.log("New game state is: " + JSON.stringify(gameState));
                    if (gameState.gameResult != null) {
                        console.log("Game is over. Computer " + gameState.gameResult + " !");
                    }
                    //logTrainedModelAsEfficiencyBoard();
                });
                delay(200);
            }
        });

        function resetGame()
        {
            getNewGameState(function(emptyGameState){
                gameState = emptyGameState;
                console.log("New game started. Game state is: " + JSON.stringify(gameState));
                updateBoard(emptyGameState);
            });
        }

        function updateBoard(gameState)
        {
            $("#0_0").html(gameState.matrix[0][0].value);
            $("#0_1").html(gameState.matrix[0][1].value);
            $("#0_2").html(gameState.matrix[0][2].value);
            $("#1_0").html(gameState.matrix[1][0].value);
            $("#1_1").html(gameState.matrix[1][1].value);
            $("#1_2").html(gameState.matrix[1][2].value);
            $("#2_0").html(gameState.matrix[2][0].value);
            $("#2_1").html(gameState.matrix[2][1].value);
            $("#2_2").html(gameState.matrix[2][2].value);

            if(gameState.gameResult != null) {

            }

        }

        function getNewGameState(callback) {
            $.get( "/tictactoe/newGameState", function(data) {
                callback(data);
            });
        }

        function sendGameState(gameState, userFigure, userMoveRow, userMoveCol, callback) {
            var url = "/tictactoe/moveAndLearn?userFigure=" + userFigure;
            url += "&userMoveRow=" + userMoveRow;
            url += "&userMoveCol=" + userMoveCol;
            $.ajax({
                url: url,
                type: "POST",
                data: JSON.stringify(gameState),
                contentType:"application/json; charset=utf-8",
                dataType:"json",
                success: function(data){
                    callback(data);
                }
            });
        }

        function logTrainedModelAsEfficiencyBoard()
        {
            $.get( "/tictactoe/trainedModelEfficiency", function(data) {
                console.log(data);
            });
        }

        function delay(milliseconds) {
            const date = Date.now();
            let currentDate = null;
            do {
                currentDate = Date.now();
            } while (currentDate - date < milliseconds);
        }

        $("form#modelUploadForm").submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);

            $.ajax({
                url: '/tictactoe/loadModel',
                type: 'POST',
                data: formData,
                success: function (message) {
                    alert(message)
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });

        $( document ).ready(function() {
            resetGame();
            console.log("Ready to play new game!")
        });
    </script>

</body>
</html>